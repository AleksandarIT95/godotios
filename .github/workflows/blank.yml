name: iOS Export and Xcode Build

on:
  push:
    branches:
      - main

jobs:
  export_and_build:
    runs-on: macOS-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Export iOS
      uses: firebelley/godot-export@v5.1.0
      with:
        godot_executable_download_url: https://downloads.tuxfamily.org/godotengine/3.5.1/Godot_v3.5.1-stable_osx.universal.zip
        godot_export_templates_download_url: https://downloads.tuxfamily.org/godotengine/3.5.1/Godot_v3.5.1-stable_export_templates.tpz
        relative_project_path: './'
        export_preset: export_presets
        export_debug: true
        export_as_pack: true

    - name: Generate Xcode Project
      run: |
        cd ios
        godot --no-window --export "iOS Xcode" ../ios_xcode/aaa.xcodeproj

    - name: Install Xcode Dependencies
      run: |
        xcode-select --install

    - name: Open Xcode Project
      run: open ios_xcode/aaa.xcodeproj

    - name: Archive iOS App
      run: |
        xcodebuild archive -workspace ios_xcode/aaa.xcworkspace -scheme MyScheme -archivePath ios_xcode/aaa.xcarchive -allowProvisioningUpdates

    - name: Export IPA
      uses: actions/upload-artifact@v2
      with:
        name: iOS Build
        path: ios_xcode/aaa.xcarchive/Products/Applications/aaa.ipa
